<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéß R√°dio Bagres üêü - YouTube (Sincronizada)</title>
    <style>
        /* ======== ESTILO GERAL ======== */
        body {
          background: linear-gradient(135deg, #1a1a1a, #222, #111);
          color: #f0f0f0;
          font-family: "Poppins", Arial, sans-serif;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          margin: 0;
          padding: 20px;
          overflow: hidden;
        }

        h2 {
          font-size: 2em;
          margin-bottom: 15px;
          background: linear-gradient(90deg, #3498db, #9b59b6);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          animation: pulse 3s infinite alternate;
          text-align: center;
        }

        @keyframes pulse {
          from { opacity: 0.8; }
          to { opacity: 1; }
        }

        /* ======== PLAYER INVIS√çVEL ======== */
        #player {
          width: 1px;
          height: 1px;
          position: absolute;
          left: -9999px;
          top: -9999px;
          overflow: hidden;
        }

        /* ======== CARD PRINCIPAL ======== */
        .radio-container {
          background: rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(10px);
          border-radius: 20px;
          box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
          padding: 30px 40px;
          text-align: center;
          width: 350px;
          max-width: 90%;
          transition: transform 0.3s ease;
        }

        .radio-container:hover {
          transform: scale(1.02);
        }

        /* ======== INFO ======== */
        #current-info {
          margin-top: 15px;
          font-size: 1.1em;
          font-weight: 500;
          color: #ccc;
          word-break: break-word;
        }

        /* ======== BOT√ïES ======== */
        .controls {
          display: flex;
          justify-content: center;
          flex-wrap: wrap;
          gap: 15px;
          margin-top: 20px;
        }

        button {
          padding: 10px 20px;
          font-size: 1em;
          font-weight: 600;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          color: #fff;
          transition: all 0.3s ease;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        #audioToggle {
          background: #3498db;
        }

        #audioToggle:hover {
          background: #2980b9;
          transform: scale(1.05);
        }

        #skipButton {
          background: #e74c3c;
        }

        #skipButton:hover {
          background: #c0392b;
          transform: scale(1.05);
        }

        /* ======== FORM DE ADI√á√ÉO ======== */
        form {
          margin-top: 30px;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 10px;
        }

        label {
          font-size: 0.9em;
          color: #aaa;
        }

        input[type="text"] {
          width: 100%;
          max-width: 260px;
          padding: 10px;
          border-radius: 8px;
          border: 1px solid #555;
          background: #222;
          color: #eee;
          font-size: 0.9em;
          outline: none;
          transition: border 0.3s ease;
        }

        input[type="text"]:focus {
          border-color: #3498db;
        }

        form button {
          background: #27ae60;
        }

        form button:hover {
          background: #219150;
        }

        /* ======== FUNDO ANIMADO ======== */
        .background-anim {
          position: fixed;
          width: 200%;
          height: 200%;
          top: -50%;
          left: -50%;
          z-index: -1;
          background: radial-gradient(circle at center, #3498db33, #000000);
          animation: rotateBg 20s linear infinite;
        }

        @keyframes rotateBg {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }

        /* ======== RESPONSIVIDADE ======== */
        @media (max-width: 600px) {
          h2 {
            font-size: 1.6em;
          }

          .radio-container {
            width: 95%;
            padding: 25px 20px;
          }

          button {
            width: 100%;
            max-width: 200px;
          }

          input[type="text"] {
            width: 90%;
          }

          #current-info {
            font-size: 1em;
          }
        }

        @media (min-width: 1200px) {
          h2 {
            font-size: 2.4em;
          }

          .radio-container {
            width: 420px;
          }
        }
    </style>
</head>
<body>
<div class="background-anim"></div>

<div class="radio-container">
    <h2>üéµ R√°dio Bagres üêü</h2>

    <div id="player"></div>
    <div id="current-info">Carregando r√°dio...</div>

    <div class="controls">
        <button id="audioToggle" onclick="toggleAudio()">Ativar √Åudio</button>
        <button id="skipButton" onclick="skipSong()">‚è≠ Pular M√∫sica</button>
    </div>

    <form id="youtube-form" onsubmit="event.preventDefault(); addMusic(document.getElementById('videoId').value);">
        <label for="videoId">YouTube URL ou Video ID:</label>
        <input id="videoId" name="videoId" type="text" placeholder="ex: https://youtu.be/abc123" required />
        <button type="submit">Adicionar</button>
    </form>
</div>

<script>
    var player;
    var currentVideoId = '';
    var isMuted = true;

    // Carrega a API do YouTube
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '270',
            width: '480',
            videoId: '',
            playerVars: {
                'autoplay': 1,
                'controls': 0,
                'modestbranding': 1,
                'rel': 0,
                'mute': 1,
                'disablekb': 1
            },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        event.target.playVideo();
        connectToMetadataStream();
    }

    function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.BUFFERING) {
            player.playVideo();
        }
        if (event.data === YT.PlayerState.ENDED) {
            skipSong();
        }
    }

    function toggleAudio() {
        const audioButton = document.getElementById('audioToggle');
        if (isMuted) {
            player.unMute();
            isMuted = false;
            audioButton.innerText = 'Desativar √Åudio';
        } else {
            player.mute();
            isMuted = true;
            audioButton.innerText = 'Ativar √Åudio';
        }
    }

    function connectToMetadataStream() {
        const eventSource = new EventSource('/radio/metadata');

        eventSource.addEventListener("sync", function(event) {
            try {
                const data = JSON.parse(event.data);
                const newVideoId = data.videoId;
                const startTimeMs = data.startTime;
                const elapsedTimeMs = Date.now() - startTimeMs;
                let seekTimeSeconds = elapsedTimeMs / 1000 + 0.20;
                if (seekTimeSeconds < 0) seekTimeSeconds = 0;

                if (newVideoId !== currentVideoId) {
                    currentVideoId = newVideoId;
                    document.getElementById('current-info').innerText = `üé∂ Tocando: ${newVideoId}`;
                    player.loadVideoById(newVideoId, seekTimeSeconds);
                    player.playVideo();
                }
            } catch (e) {
                console.error("Erro ao processar dados de sincroniza√ß√£o:", e);
            }
        });

        eventSource.onerror = function(err) {
            console.error("SSE falhou. Tentando reconectar...", err);
            eventSource.close();
            setTimeout(connectToMetadataStream, 5000);
        };
    }

    async function skipSong() {
        document.getElementById('current-info').innerText = '‚è≠ Pulando m√∫sica...';
        try {
            const response = await fetch('/radio/skip', { method: 'POST' });
            if (response.ok) {
                const message = await response.text();
                console.log("Skip bem-sucedido:", message);
            } else {
                alert("Falha ao pular m√∫sica.");
            }
        } catch (error) {
            alert("Erro de rede.");
        }
    }

    async function addMusic(urlMusic) {
        const videoId = extractYouTubeId(urlMusic);
        await fetch('/radio/add-youtube', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'videoId=' + encodeURIComponent(videoId)
        });
        document.getElementById('videoId').value = '';
    }

    function extractYouTubeId(input) {
        const match = input.match(/[?&]v=([^&]+)/);
        if (match) return match[1];
        const shortMatch = input.match(/youtu\.be\/([^?&]+)/);
        if (shortMatch) return shortMatch[1];
        return input;
    }
</script>
</body>
</html>
